<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="shared-styles.html">
<script type="text/javascript" src="../bower_components/moment/min/moment.min.js"></script>

<dom-module id="blog-summary">
  <template>
      <style include="iron-flex iron-flex-alignment shared-styles">
        :host {
          display: block;
          padding: 10px;
        }

        paper-card {
          width: 400px;
          margin: 5px auto;
        }

        .card-content h1 {
          margin-bottom: 10px;
        }

        .card-content .info {
          margin: 0;
        }
      </style>

      <iron-ajax
        id="requestor"
        auto
        url="/src/blog/blog.json"
        handle-as="json"
        on-response="handleCall"
        debounce-duration="300"></iron-ajax>

    <section class="layout horizontal wrap">
      <template is="dom-repeat" items="[[posts]]" as="post">
        <paper-card image="[[post.image]]">
          <section class="card-content">
            <h1>[[post.title]]</h1>
            <div class="info layout horizontal">
              <small class="flex">By [[post.author]]</small>
              <small>Posted [[friendlyDate(post.createdAt)]]</small>
            </div>
            <p>[[post.description]]</p>
          </section>
          <div class="card-actions">
            <paper-button>Full Article</paper-button>
          </div>
        </paper-card>
      </template>
    </section>

  </template>

  <script>
    Polymer({
      is: 'blog-summary',
      properties: {
        posts: {
          type: Array,
          notify: true,
          value: function () { return []; } // Default value
        },
        limit: {
          type: Number,
          notify: false,
          value: 0
        }
      },
      handleCall: function() {
        var res = this.$.requestor.lastResponse;
        //console.log(res);
        var _self = this;
        // here each key is a blog post
        var keys = Object.keys(res);
        // if no limit or limit higher than number of posts, use number of posts
        var max = (this.limit === 0 || this.limit > keys.length) ? keys.length : this.limit;
        for (var i = 0; i < max; i++)
          _self.push('posts', res[keys[i]]);
      },
      friendlyDate: function (dateString) {
        return moment(dateString).format('YYYY-MM-DD')
      }
    });

  </script>
</dom-module>